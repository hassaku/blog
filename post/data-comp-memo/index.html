
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    データ分析コンペとかによくやる作業 | hassaku&#39;s blog
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="http://blog.hassaku-labs.com/post/data-comp-memo/"/>

  
  <link rel="stylesheet" href="http://blog.hassaku-labs.com/css/sanitize.css">
  <link rel="stylesheet" href="http://blog.hassaku-labs.com/css/responsive.css">
  <link rel="stylesheet" href="http://blog.hassaku-labs.com/css/highlight_monokai.css">
  <link rel="stylesheet" href="http://blog.hassaku-labs.com/css/theme.css">
  <link rel="stylesheet" href="http://blog.hassaku-labs.com/css/custom.css">
  
  
  <link href="http://blog.hassaku-labs.com/index.xml" rel="alternate" type="application/rss+xml" title="hassaku&#39;s blog" />
  <link href="http://blog.hassaku-labs.com/index.xml" rel="feed" type="application/rss+xml" title="hassaku&#39;s blog" />

  
  <script type="text/javascript">var switchTo5x=true;</script>
  <script type="text/javascript" src="https://ws.sharethis.com/button/buttons.js"></script>
  <script type="text/javascript">stLight.options({publisher: "2b9fffc6-b3fe-4988-a0ef-4f9dcce98eaa", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script>


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://blog.hassaku-labs.com/">hassaku&#39;s blog</a></h1>
        <h2>３歩進んで２歩分滑り落ちてくペンギンのメモ</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          
          
          <li><a href="https://github.com/hassaku" target="_blank">GitHub</a></li>
          
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>データ分析コンペとかによくやる作業</h1>
      <div class="meta">
        May 3, 2019 &nbsp;
        
          #<a href="http://blog.hassaku-labs.com/tags/python">python</a>&nbsp;
        
      </div>
    </div>
    <article>
      

<h1 id="大きいデータの読み込み">大きいデータの読み込み</h1>

<p>daskを使って並列処理</p>

<pre><code>import dask.dataframe as ddf
import dask.multiprocessing

df = ddf.read_csv('train_data.csv')
df = df.compute(get=dask.multiprocessing.get)
</code></pre>

<h1 id="eda">EDA</h1>

<p>データに関する簡単な統計情報確認</p>

<pre><code>import pandas_profiling as pdp
pdp.ProfileReport(df)
</code></pre>

<p>データの相関を確認</p>

<pre><code>import seaborn as sns
sns.pairplot(df, hue=&quot;target&quot;, diag_kind=&quot;kde&quot;)
</code></pre>

<h1 id="前処理">前処理</h1>

<ul>
<li>欠損値の補完</li>
<li>外れ値の削除</li>
<li>カテゴリ変数の扱い

<ul>
<li>one hot encoding （次元増える系）</li>
<li>どれかひとつだけ1になるようなスパースなベクトル表現
<code>
city_dummies = pd.get_dummies(df[&quot;city&quot;], prefix=&quot;city&quot;)
df.drop([&quot;city&quot;], axis=1, inplca=True)
df = df.join(city_dummies)
</code></li>
<li>count encoding （次元増えない系）</li>
<li>カテゴリ変数の出現回数（あるいは率）を値とするような表現
<code>
df['count_city'] = df.groupby('city')['target'].transform('count')
</code></li>
</ul></li>
<li>並列処理
```
import numpy as np
import pandas as pd
#import multiprocessing as mp  # impossible to use lambda with pickle
import pathos.multiprocessing as mp  # dill is used inside instead of pickle.</li>
</ul>

<p>def split_parallel(df, num_split, map_func):
      with mp.Pool(num_split) as p:
          df_split = np.array_split(df, num_split*2)
          result = p.map(map_func, df_split)
      return pd.concat(result)</p>

<p>NUM_PARALLELS = 3
  df[&ldquo;new_col&rdquo;] = split_parallel(df, NUM_PARALLELS, lambda x: x[&ldquo;col1&rdquo;] + x[&ldquo;col2&rdquo;])</p>

<pre><code>
# CV

</code></pre>

<p>from sklearn.model_selection import StratifiedKFold</p>

<p>cv = StratifiedKFold(n_splits=5, shuffle=True, random_state=123)
X_train = np.zeros(20, 5)
y_train = np.zeros(20)</p>

<p>for train_idx, valid_idx in cv.split(X_train, y_train):
    print(train_idx, valid_idx)
    &hellip;
    losses.append(loss)</p>

<p>cv_loss = np.mean(losses)</p>

<pre><code>
# 結果のアンサンブル

</code></pre>

<p>res1 = pd.read_csv(&lsquo;../method1/submission.csv&rsquo;)
res2 = pd.read_csv(&lsquo;../method2/submission.csv&rsquo;)
res3 = pd.read_csv(&lsquo;../method3/submission.csv&rsquo;)</p>

<p>b1 = res1.copy()
col = res1.columns</p>

<p>col = col.tolist()
col.remove(&lsquo;id&rsquo;)
for i in col:
    b1[i] = (2 * res1[i]  + 2 * res2[i] + 4 * res3[i]) / 6.0</p>

<p>b1.to_csv(&lsquo;submission.csv&rsquo;, index=False)</p>

<pre><code>
# Jupyter Notebook上でCSVの確認とダウンロード

実行するとディレクトリ内のファイル一覧が表示されて、クリックすればダウンロード出来るはず

</code></pre>

<p>from IPython.display import FileLinks
FileLinks(DATA_DIR)
```</p>

      
      
      <div id="share-this" class="col span_10">
        <span class='st_twitter_large' displayText='Tweet'></span>
        <span class='st_facebook_large' displayText='Facebook'></span>
        <span class='st_googleplus_large' displayText='Google +'></span>
        <span class='st_pocket_large' displayText='Pocket'></span>
        <span class='st_sharethis_large' displayText='ShareThis'></span>
        <span class='st_email_large' displayText='Email'></span>  
      </div>
    </article>
    
 <aside><div id="disqus_thread"></div></aside> 

<script type="text/javascript">
     
    var disqus_shortname = 'hassakusblog';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </main>
  
  <nav class="pagination">
    
      <span class="previous">&larr; <a href="http://blog.hassaku-labs.com/post/ai-ideas/" rel="prev">人工知能実現のための要素技術アイデア</a></span>
    
    
      <span class="next"><a href="http://blog.hassaku-labs.com/post/machine-learning-project/" rel="next">機械学習技術を使った実際の研究開発プロジェクトについて</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="http://blog.hassaku-labs.com/images/profile.png" width="64" height="64"><br>
      Written by hassaku
    </div>
  </footer>


</div>

<script src="http://blog.hassaku-labs.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-31136981-6', 'auto');
	ga('send', 'pageview');
</script>

</body>
</html>

