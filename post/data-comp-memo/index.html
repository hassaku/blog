
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    データ分析コンペとかによくやる作業 | hassaku&#39;s blog
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="https://blog.hassaku-labs.com/post/data-comp-memo/"/>

  
  <link rel="stylesheet" href="https://blog.hassaku-labs.com/css/sanitize.css">
  <link rel="stylesheet" href="https://blog.hassaku-labs.com/css/responsive.css">
  <link rel="stylesheet" href="https://blog.hassaku-labs.com/css/highlight_monokai.css">
  <link rel="stylesheet" href="https://blog.hassaku-labs.com/css/theme.css">
  <link rel="stylesheet" href="https://blog.hassaku-labs.com/css/custom.css">
  
  
  <link href="https://blog.hassaku-labs.com/index.xml" rel="alternate" type="application/rss+xml" title="hassaku&#39;s blog" />
  <link href="https://blog.hassaku-labs.com/index.xml" rel="feed" type="application/rss+xml" title="hassaku&#39;s blog" />

  
  <script type="text/javascript">var switchTo5x=true;</script>
  <script type="text/javascript" src="https://ws.sharethis.com/button/buttons.js"></script>
  <script type="text/javascript">stLight.options({publisher: "2b9fffc6-b3fe-4988-a0ef-4f9dcce98eaa", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script>


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="https://blog.hassaku-labs.com/">hassaku&#39;s blog</a></h1>
        <h2>３歩進んで２歩分滑り落ちてくペンギンのメモ</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          
          
          <li><a href="https://github.com/hassaku" target="_blank">GitHub</a></li>
          
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>データ分析コンペとかによくやる作業</h1>
      <div class="meta">
        May 3, 2019 &nbsp;
        
          #<a href="https://blog.hassaku-labs.com/tags/python">python</a>&nbsp;
        
      </div>
    </div>
    <article>
      <h1 id="大きいデータの読み込み">大きいデータの読み込み</h1>
<p>daskを使って並列処理</p>
<pre tabindex="0"><code>import dask.dataframe as ddf
import dask.multiprocessing

df = ddf.read_csv(&#39;train_data.csv&#39;)
df = df.compute(get=dask.multiprocessing.get)
</code></pre><h1 id="eda">EDA</h1>
<p>データに関する簡単な統計情報確認</p>
<pre tabindex="0"><code>import pandas_profiling as pdp
pdp.ProfileReport(df)
</code></pre><p>データの相関を確認</p>
<pre tabindex="0"><code>import seaborn as sns
sns.pairplot(df, hue=&#34;target&#34;, diag_kind=&#34;kde&#34;)
</code></pre><h1 id="前処理">前処理</h1>
<ul>
<li>欠損値の補完</li>
<li>外れ値の削除</li>
<li>カテゴリ変数の扱い
<ul>
<li>one hot encoding （次元増える系）
<ul>
<li>どれかひとつだけ1になるようなスパースなベクトル表現</li>
</ul>
</li>
</ul>
<pre tabindex="0"><code>city_dummies = pd.get_dummies(df[&#34;city&#34;], prefix=&#34;city&#34;)
df.drop([&#34;city&#34;], axis=1, inplca=True)
df = df.join(city_dummies)
</code></pre><ul>
<li>count encoding （次元増えない系）
<ul>
<li>カテゴリ変数の出現回数（あるいは率）を値とするような表現</li>
</ul>
</li>
</ul>
<pre tabindex="0"><code>df[&#39;count_city&#39;] = df.groupby(&#39;city&#39;)[&#39;target&#39;].transform(&#39;count&#39;)
</code></pre></li>
<li>並列処理
<pre tabindex="0"><code>import numpy as np
import pandas as pd
#import multiprocessing as mp  # impossible to use lambda with pickle
import pathos.multiprocessing as mp  # dill is used inside instead of pickle.

def split_parallel(df, num_split, map_func):
    with mp.Pool(num_split) as p:
        df_split = np.array_split(df, num_split*2)
        result = p.map(map_func, df_split)
    return pd.concat(result)

NUM_PARALLELS = 3
df[&#34;new_col&#34;] = split_parallel(df, NUM_PARALLELS, lambda x: x[&#34;col1&#34;] + x[&#34;col2&#34;])
</code></pre></li>
</ul>
<h1 id="cv">CV</h1>
<pre tabindex="0"><code>from sklearn.model_selection import StratifiedKFold

cv = StratifiedKFold(n_splits=5, shuffle=True, random_state=123)
X_train = np.zeros(20, 5)
y_train = np.zeros(20)

for train_idx, valid_idx in cv.split(X_train, y_train):
    print(train_idx, valid_idx)
    ...
    losses.append(loss)

cv_loss = np.mean(losses)
</code></pre><h1 id="結果のアンサンブル">結果のアンサンブル</h1>
<pre tabindex="0"><code>res1 = pd.read_csv(&#39;../method1/submission.csv&#39;)
res2 = pd.read_csv(&#39;../method2/submission.csv&#39;)
res3 = pd.read_csv(&#39;../method3/submission.csv&#39;)

b1 = res1.copy()
col = res1.columns

col = col.tolist()
col.remove(&#39;id&#39;)
for i in col:
    b1[i] = (2 * res1[i]  + 2 * res2[i] + 4 * res3[i]) / 6.0

b1.to_csv(&#39;submission.csv&#39;, index=False)
</code></pre><h1 id="jupyter-notebook上でcsvの確認とダウンロード">Jupyter Notebook上でCSVの確認とダウンロード</h1>
<p>実行するとディレクトリ内のファイル一覧が表示されて、クリックすればダウンロード出来るはず</p>
<pre tabindex="0"><code>from IPython.display import FileLinks
FileLinks(DATA_DIR)
</code></pre>
      
      
      <div id="share-this" class="col span_10">
        <span class='st_twitter_large' displayText='Tweet'></span>
        <span class='st_facebook_large' displayText='Facebook'></span>
        <span class='st_googleplus_large' displayText='Google +'></span>
        <span class='st_pocket_large' displayText='Pocket'></span>
        <span class='st_sharethis_large' displayText='ShareThis'></span>
        <span class='st_email_large' displayText='Email'></span>  
      </div>
    </article>
    

  </main>
  
  <nav class="pagination">
    
      <span class="previous">&larr; <a href="https://blog.hassaku-labs.com/post/machine-learning-project/" rel="prev">機械学習技術を使った実際の研究開発プロジェクトについて</a></span>
    
    
      <span class="next"><a href="https://blog.hassaku-labs.com/post/ai-ideas/" rel="next">人工知能実現のための要素技術アイデア</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="https://blog.hassaku-labs.com/images/profile.png" width="64" height="64"><br>
      Written by hassaku
    </div>
  </footer>


</div>

<script src="https://blog.hassaku-labs.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-31136981-6', 'auto');
	ga('send', 'pageview');
</script>

</body>
</html>

